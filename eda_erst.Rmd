---
title: 'Exploratory Data Analysis: Electric Retail Service Territories'
author: "Eric Scheier"
date: "3/19/2020"
output:
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sf)
```
# Introduction

# Acquiring Data

```{r}
# https://hifld-geoplatform.opendata.arcgis.com/datasets/c4fd0b01c2544a2f83440dab292f0980_0
erst_name <- "Electric_Retail_Service_Territories"

url_list <- list(
  "csv" = "https://opendata.arcgis.com/datasets/c4fd0b01c2544a2f83440dab292f0980_0.csv?outSR=%7B%22latestWkid%22%3A3857%2C%22wkid%22%3A102100%7D",
  "kml" = "https://opendata.arcgis.com/datasets/c4fd0b01c2544a2f83440dab292f0980_0.kml?outSR=%7B%22latestWkid%22%3A3857%2C%22wkid%22%3A102100%7D",
  "zip" = "https://opendata.arcgis.com/datasets/c4fd0b01c2544a2f83440dab292f0980_0.zip?outSR=%7B%22latestWkid%22%3A3857%2C%22wkid%22%3A102100%7D",
  "gdb" = "https://opendata.arcgis.com/datasets/c4fd0b01c2544a2f83440dab292f0980_0.gdb?outSR=%7B%22latestWkid%22%3A3857%2C%22wkid%22%3A102100%7D")

for (i in 1:length(url_list)){
  file_name <- names(url_list)[i]
  data_url <- url_list[[file_name]]
  desired_name <- paste0(erst_name,".",file_name)
  desired_path <- file.path(desired_name)
  
  if (!file.exists(desired_path)){
    print(paste0("Downloading ",desired_name))
    download.file(data_url,desired_path)
    if (file_name=="zip"){
      unzip(desired_path)
    }
  }
}
```


```{r}
data_shp <- st_read(paste0(erst_name,".shp"))

# https://gis.stackexchange.com/questions/64654/choosing-the-correct-value-for-proj4string-for-shapefile-reading-in-r
#shp <- st_transform(shp, "+init=epsg:3857")

summary(data_shp)
```

```{r}
str(data_shp)
```

```{r}
plot(data_shp$geometry)
```


```{r}
data <- data_shp %>% st_drop_geometry()

str(data)
```


# Data Munging

Munging Steps:

+ Limit to North Carolina Utilities
+ Replace `-999999` with `NA`

## Limit to NC Utilities

For now I will limit by the state name of the serving utility. Soon, I will select by those territories which overlap with the NC state boundary.

```{r}
data <- data[data$STATE=="NC",]
#plot(data_shp$geometry)
```

## Replace `-999999` with `NA`

```{r}
na_num_placeholder <- -999999.0

na_num_colnames <- c("SUMMR_PEAK",
             "WINTR_PEAK",
             "SUMMER_CAP",
             "WINTER_CAP",
             "NET_GEN",
             "PURCHASED",
             "NET_EX",
             "RETAIL_MWH",
             "WSALE_MWH",
             "TOTAL_MWH",
             "TRANS_MWH",
             "CUSTOMERS")

na_num_cols <- which(names(data) %in% na_num_colnames)

data[, na_num_cols][data[, na_num_cols] == na_num_placeholder] <- NA

summary(data[na_num_cols])
```

## Replace `NOT AVAILABLE` with `NA`

```{r}
na_txt_placeholder <- "NOT AVAILABLE"

na_txt_colnames <- c("REGULATED",
               "CNTRL_AREA",
               "PLAN_AREA",
               "HOLDING_CO")

na_txt_cols <- which(names(data) %in% na_txt_colnames)

data[, na_txt_cols][data[, na_txt_cols] == na_txt_placeholder] <- NA

summary(data[na_txt_cols])
```


```{r}
keep_cols <- c("OBJECTID",
               "ID",
               "NAME",
               "TYPE",
               na_txt_colnames,
               na_num_colnames)

data <- data[keep_cols]
```


```{r}
final_data <- left_join(data, data_shp[c("OBJECTID","geometry")], by="OBJECTID")

summary(final_data)
```


```{r}
plot(final_data$geometry)
```


# Questions

+ What percent of the state's land/customers/load is served by these territories
+ What percent of the state's land/customers/load is served by Investor Owned Utilities, Cooperatives, or Municipal Providers