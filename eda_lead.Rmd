---
title: 'Exploratory Data Ananlysis: Low-Income Energy Affordability Data'
author: "Eric Scheier"
date: "3/19/2020"
output:
  md_document:
    variant: markdown_github
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
```
# Introduction

```{r}
acs_date <- 2016
```


This is an exploratory data analysis of the Low Income Energy Affordability Data [LEAD](https://catalog.data.gov/dataset/low-income-energy-affordability-data-lead-tool) from the Department of Energy (DOE). This dataset represents an estimate of the monthly energy bills and average incomes of households in the united states, segmented by the following characteristics:

- Year of building first construction
- Number of units in the building
- Primary heating fuel type
- Whether the residents own or rent the unit
- Household income relative to Area Median Income or Federal Poverty Level
- State
- County, City, or Census Tract

For this project, I will use the data which displays the results by census tract in terms of Area Median Income for the state of North Carolina.

```{r cache=TRUE}
base_url <- "https://openei.org/doe-opendata/dataset/9dcd443b-c0e5-4d4a-b764-5a8ff0c2c92b/resource/831ac481-1a60-4f87-a887-15b310ffff53/download/"


file_name <- "ami68tractshnc"
data_url <- paste0(base_url,file_name,".csv")
desired_name <- paste0(file_name,".csv")
desired_path <- file.path(desired_name)

download.file(data_url,desired_path)
```

A full data dictionary is available, and downloaded below.

```{r}
# https://readxl.tidyverse.org/articles/articles/readxl-workflows.html

read_then_csv <- function(sheet, path) {
  pathbase <- path %>%
    basename() %>%
    tools::file_path_sans_ext()
  path %>%
    read_excel(sheet = sheet, col_names = FALSE, col_types = "text") %>% 
    write_csv(paste0(sheet, ".csv"))
}

url <- "https://openei.org/doe-opendata/dataset/9dcd443b-c0e5-4d4a-b764-5a8ff0c2c92b/resource/51a2cd49-fd61-4842-82e2-2f90ffec7e42/download/datadictionary.xlsx"
temp <- tempfile()
download.file(url,temp,mode="wb")
path <- temp
path %>%
  excel_sheets() %>%
  set_names() %>% 
  map(read_then_csv, path = path)

data_dict <- read_csv("Data Dictionary.csv")

ybl_dict <- data_dict[1:7,1:2]
ybl_dict[1,2] <- data_dict[1,3]
names(ybl_dict) <- as.matrix(ybl_dict[1, ])
ybl_dict <- ybl_dict[-1, ]

bld_dict <- data_dict[9:18,1:2]
bld_dict[1,2] <- data_dict[9,3]
names(bld_dict) <- as.matrix(bld_dict[1, ])
bld_dict <- bld_dict[-1, ]

hfl_dict <- data_dict[20:29,1:2]
hfl_dict[1,2] <- data_dict[20,3]
names(hfl_dict) <- as.matrix(hfl_dict[1, ])
hfl_dict <- hfl_dict[-1, ]

burden_dict <- data_dict[1:9,7:8]
names(burden_dict) <- c("Variable", "Description")
burden_dict <- rbind(burden_dict, names(hfl_dict), names(bld_dict), names(ybl_dict))
burden_dict
```


```{r}
data <- read_csv(desired_path)

summary(data)
```

# Data Munging

Munging Steps:

- Remove rows where `UNITS<1`.
- Seperate the `AMI68` column into `occupancy_type` and `income_bracket` columns
- Create `min_age` from `YBL INDEX`.
- Create `min_units` from `BLD INDEX`.
- Create `detached` from `BLD INDEX`.

## Remove Fractional Units

The estimation procedure used by the DOE results in an estimated number of occupied housing units meeting the subset characteristics (`UNITS`) and displays the number of American Community Survey responses that contribute to the estimate of energy expenditures (`COUNT`). We first remove any categories that have fewer than 1 unit represented, since this is not physically possible.

```{r}
#Remove rows where `UNITS<1`.

data <- data[data$UNITS>=1,]
```

This results in removing `r 100*sum(data$UNITS<1)/length(data$UNITS)`% of the available rows (gross: `r sum(data$UNITS<1)` rows of `r length(data$UNITS)`). This is a total of `r sum(data$UNITS[data$UNITS<1])` housing units, or `r 100*sum(data$UNITS[data$UNITS<1])/sum(data$UNITS)`% of the estimated total `r sum(data$UNITS)` units in the state.

## Break Out Ownership & Income Bracket

The data combines the unit's ownership status (`OWNER` vs. `RENTER`) and income bracket as a fraction of Area Median Income (`0-30%`, `30-60%`, `60-80%`, `80-100%`, or `100%+`) into the same column (e.g. `r data$AMI68[1]`). This `AMI68` column needs to be seperated for meaningful analysis. These categorical variables are saved as factors.

```{r}
#Seperate the `AMI68` column into `occupancy_type` and `income_bracket` columns

data <- data %>% 
  separate(col="AMI68",
           into=c("occupancy_type", "income_bracket"), 
           sep = " ", 
           remove = FALSE, 
           convert = FALSE,
           extra = "warn", 
           fill = "warn")

data$occupancy_type <- as.factor(data$occupancy_type)
data$income_bracket <- as.factor(data$income_bracket)
```

## Create Meaningful Indicators from Indices

The `YBL INDEX` and `BLD INDEX` columns need some further treatment. `YBL INDEX` represents the year the building was first constructed, but is an index seperated into 10-20 year increments dating back to 1940. 

```{r}
ybl_dict
```


Since these indeces represent different possible ages and the increments are not uniform, I will add a numerical indicator (`min_age`) to represent the youngest age the building could possibly be based on its category. Thus, a building in the `2010+` range must be at least 0 years old (this data was collected in `r acs_date`), in the `1980-99` range at least `r acs_date-1980` years old, in the `BEFORE 1940` range at least `r acs_date-1940`, etc. I choose youngest rather than oldest age because it avoids the requirement to make an assumption about the oldest age of buildings built before 1940. 

```{r}
#Create `min_age` from `YBL INDEX`.


```


```{r}
#Create `min_units` from `BLD INDEX`.
```


```{r}
#Create `detached` from `BLD INDEX`.


```



Questions:

- How many ACS survey responses inform each segment? (`COUNT` vs `UNITS`)
- Are there any trends in the energy burden based on age, units/building, home ownership, home attachment, ?
- Perform a principal component analysis
- Does `YBL INDEX` or `min_age` better explain the energy burden variance?
- Does `BLD INDEX` or `min_units` better explain the energy burden variance?