---
title: 'Net Energy Equity: Methods'
author: "Eric Scheier"
date: "`r format(Sys.time(), '%Y-%B-%d')`"
output:
  html_document: default
  pdf_document: default
  tufte::tufte_handout: default
  word_document: default
---

```{r setup, include=FALSE}
is_final=FALSE
is_preview=TRUE
is_draft=TRUE
set.seed(123)

knitr::opts_chunk$set(comment='##', 
                      collapse=ifelse(is_preview,TRUE,!is_draft),
                      echo=ifelse(is_preview,FALSE,is_draft),
                      eval=TRUE,
                      warning=ifelse(is_preview,FALSE,is_draft),
                      error=ifelse(is_preview,FALSE,is_draft),
                      results=ifelse(is_final,'hide',ifelse(is_preview,'hide','asis')),
                      fig.keep='all',
                      message=ifelse(is_preview,FALSE,is_draft),
                      include=ifelse(is_preview,TRUE,is_draft),
                      tidy=TRUE,
                      cache=FALSE,
                      fig.margin=FALSE,
                      fig.fullwidth = FALSE
                      )
```

```{r include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
kable(knitr::opts_chunk$get() %>% enframe())
```


```{r}
library(tidyverse)
library(sf)
library(MASS)
library(scales)
library(caret)
library(spatstat)
library(GGally)
library(ggpubr)
library(patchwork)
library(mgcv)
library(tidyselect)
library(RColorBrewer)
library(wesanderson)
library(tigris)
library(readxl)
library(tidyverse)
```


```{r}
source("ratios.R")
source("charts.R")
```

# Loading Data

```{r}
data <- read_csv("clean_data.csv")
```

# Calculating Additional Metrics

## Poverty

```{r}
income_metric <- "ami68"
```


```{r echo=TRUE}
if(income_metric=="fpl15"){
  poverty_cutoff <- "0-100%"
} else if (income_metric=="ami68"){
  poverty_cutoff <- "very_low"
}

data$in_poverty <- as.factor(ifelse(data$income_bracket==poverty_cutoff,"Poverty", "Prosperity"))
```

How many households are below the poverty line in this data?

```{r}
total_households <- sum(data$households)

number_in_poverty <- sum((data$income_bracket==poverty_cutoff) * (data$households))

pct_in_poverty <- number_in_poverty / total_households

number_above_poverty <- sum((data$income_bracket!=poverty_cutoff) * (data$households))

pct_above_poverty <- number_above_poverty / total_households
```


## Annual Energy Spending

```{r echo=TRUE}
data$annual_energy_cost <- 12*(data$replica_electricity_spend + 
                              data$lead_gas_spend + 
                              data$lead_other_spend)
#12*data$mean_energy_cost
```

## Net Income

```{r echo=TRUE}
data$net_annual_income <- data$annual_income - (data$annual_energy_cost)
```

## Annual Energy Procurement (kWh)

```{r echo=TRUE}
# convert natural gas consumption to kWh 
data$gas_Mcf <- data$lead_gas_spend / data$dlrs_Mcf
data$gas_therms <- data$gas_Mcf / 10.37
data$gas_kWh <- data$gas_therms * 29.3001
# (use fixed for now, can make dynamic based on market heating values eventually)
# calculate electricity implied usage
data$electricity_kWh <- data$replica_electricity_spend / data$dlrs_kwh
# add natgas energy value to electricity implied usage
data$total_kWh <- data$gas_kWh + data$electricity_kWh
data$annual_kWh <- 12*data$total_kWh
# add other fuel energy values as future research
```

```{r}
# show some pie / bar charts of the breakdown between fuels
```


# Adding Net Energy Analysis Metrics

Most/All Net Energy Analysis metrics are composed of the gross amount of resource extracted, and the amount of resource spent in the extraction process. For households extracting income from the economy, these ratios will be composed of:

`g` = gross income
`s` = spending on energy

How are these metrics related? We are specifically curious about the relationship among households considered to be in poverty by the federal government.

```{r}
ggplot(data=data, aes(x=annual_income, y=annual_energy_cost, color=in_poverty)) + 
  geom_point(aes(size=households), alpha=0.05, show.legend = FALSE) + 
  geom_smooth(method=lm,
                se=TRUE,
                fullrange=TRUE)# + 
  #xlim(0,500000)
  
```

From these metrics we can create all of the relevant energy ratios:

## Traditional Energy Burden Indicator

`energy_burden = s/g`


```{r}
# Create the Energy Burden Indicator `mean_energy_burden`.

# data$energy_burden <- data$mean_energy_cost / (data$annual_income/12.0)
data$energy_burden <- energy_burden_func(g=data$annual_income,
                                         s=data$annual_energy_cost)
```

Energy poverty is commonly defined as an expenditure of greater than 10% of household income on energy^[D. J. Bednar and T. G. Reames, “Recognition of and response to energy poverty in the United States,” Nature Energy, 2020.]. This level will be referred to as the "Energy Poverty Line" and translated into its relative level for the other ratios below.

```{r}
energy_burden_poverty_line <- 0.10

#For further analysis, I will add a designation of whether a cohort is, on average, in energy poverty depending on whether the mean energy burden is above `r label_percent()(energy_burden_poverty_line)`.

data$energy_burden_poverty <- as.logical(data$energy_burden > energy_burden_poverty_line)
```

## Energy Return on Investment

`eroi = g/s`

```{r}
# Create the Energy Return on Investment Indicator `eroi`
# data$eroi <- data$annual_income / (12*data$mean_energy_cost)
data$eroi <- eroi_func(g=data$annual_income,
                       s=data$annual_energy_cost)

eroi_poverty_line <- eroi_func(g=1,
                               s=energy_burden_poverty_line)
```


## Net Energy Ratio (or Net Energy Return)

`ner = (g-s)/s`

```{r}
# data$ner <- (data$annual_income - (12*data$mean_energy_cost)) / (12*data$mean_energy_cost)
data$ner <- ner_func(g=data$annual_income,
                     s=data$annual_energy_cost,
                     se=data$annual_kWh)

average_energy_cost <- weighted.mean(data$annual_energy_cost, 
                                     data$annual_kWh*data$households, 
                                     na.rm = T)/weighted.mean(data$annual_kWh,
                                                              data$households,
                                                              na.rm = T)

ner_poverty_line <- ner_func(g=1,
                             s=energy_burden_poverty_line,
                             se=energy_burden_poverty_line/(average_energy_cost))



```

## Discretionary Energy Availability Rate

`dear = (g-s)/g`

This is equal to `1 - energy_burden`.

```{r}
# data$dear <- (data$annual_income - (12*data$mean_energy_cost)) / data$annual_income
data$dear <- dear_func(g=data$annual_income,
                       s=data$annual_energy_cost)

dear_poverty_line <- dear_func(g=1,
                               s=energy_burden_poverty_line)
```


## Filter Outliers

```{r}
metric_name <- "ner"
metric_cutoff_level <- ner_poverty_line
group_variable <- NULL# "GEOID" #"state_abbr" #merge_geo_id" #
group_columns <- c(group_variable) #c("gisjoin") #
graph_data <- filter_graph_data(data, group_columns, metric_name)

top_metrics <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=0.999, 
                         lower_quantile_view=0.001)
head(top_metrics)
```

```{r}
# need to update this for being at this stage of the production
# not sure what is going on with this particular outlier tract, seems to be a park with 500 residents
# removed manually for now 
clean_data <- data[!(data$geo_id %in% c("36005027600")) & 
                     (data$ner<=top_metrics$metric_upper) & 
                     (data$ner>=top_metrics$metric_lower), ] #drop_na(data)

write_csv(clean_data, "very_clean_data.csv")
```
