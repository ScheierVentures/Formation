---
title: 'Net Energy Equity: Chartbook'
author: "Eric Scheier"
date: "`r format(Sys.time(), '%Y-%B-%d')`"
output:
  html_document: default
  pdf_document: default
  tufte::tufte_handout: default
  word_document: default
---

```{r setup, include=FALSE}
is_final=FALSE
is_preview=TRUE
is_draft=TRUE
set.seed(123)

knitr::opts_chunk$set(comment='##', 
                      collapse=ifelse(is_preview,TRUE,!is_draft),
                      echo=ifelse(is_preview,FALSE,is_draft),
                      eval=TRUE,
                      warning=ifelse(is_preview,FALSE,is_draft),
                      error=ifelse(is_preview,FALSE,is_draft),
                      results=ifelse(is_final,'hide',ifelse(is_preview,'hide','asis')),
                      fig.keep='all',
                      message=ifelse(is_preview,FALSE,is_draft),
                      include=ifelse(is_preview,TRUE,is_draft),
                      tidy=TRUE,
                      cache=FALSE,
                      fig.margin=FALSE,
                      fig.fullwidth = FALSE
                      )
```

```{r include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
kable(knitr::opts_chunk$get() %>% enframe())
```


```{r}
library(tidyverse)
library(sf)
library(MASS)
library(scales)
library(caret)
library(spatstat)
library(GGally)
library(ggpubr)
library(patchwork)
library(mgcv)
library(tidyselect)
library(RColorBrewer)
library(wesanderson)
library(tigris)
library(readxl)
library(tidyverse)
source("charts.R")
```

```{r}
groups_of_columns <- list(c("state_abbr")
                          )#,

more_columns <- list(c("income_bracket"),
                          c("occupancy_type"),
                          c("company_ty"),
                          c("company_na"),
                          # c("solar_primary_heating_fuel", "in_poverty"),
                          c("number_of_units"),
                          c("number_of_units", "occupancy_type"),
                          c("occupancy_type", "income_bracket"),
                          c("number_of_units", "occupancy_type", "income_bracket"),
                          c("year_constructed"),
                          c("in_poverty"),
                          c("gisjoin"),
                          c("moisture_regime"),
                          c("locale"),
                          c("climate_zone_description"),
                          c("lihtc_qualified")
                          # c("primary_heating_fuel")
                          )
if(is_preview==FALSE){groups_of_columns <- c(groups_of_columns, more_columns)}else{
  groups_of_columns <- groups_of_columns[1]
}

group_columns <- groups_of_columns[[1]]

names(groups_of_columns) <- paste0(groups_of_columns, collapse =  ", ")

```



```{r echo=FALSE, results="asis", fig.cap =  names(groups_of_columns)}
for(group_columns in groups_of_columns){
  
  # print("graph_1")
  x <- make_all_charts(clean_data=clean_data,
                group_columns=group_columns,
                metric_name=metric_name, 
                metric_label=metric_label, 
                metric_cutoff_level=metric_cutoff_level,
                metric_cutoff_label=metric_cutoff_label,
                upper_quantile_view=upper_quantile_view,
                lower_quantile_view=lower_quantile_view,
                chart_title=chart_title,
                chart_subtitle=chart_subtitle)
  print(x)
  cat('\n\n') 
  
  graph_data <- filter_graph_data(clean_data, group_columns, metric_name)
  
  y <- make_violin_plot()
  
  print(y)
  cat('\n\n') 
  z <- calculate_weighted_metrics(graph_data=filter_graph_data(clean_data, 
                                                               group_columns, 
                                                               metric_name), 
                                                 group_columns, 
                                                 metric_name, 
                                                 metric_cutoff_level, 
                                                 upper_quantile_view, 
                                                 lower_quantile_view) %>% t() %>% 
    kable() %>% kable_styling("striped", full_width = F) %>% 
    column_spec(1, bold = T, border_right = T) %>%
    footnote(general=if(is.null(group_columns)){
          group_columns
          } else {
            paste0("Grouped By: ",paste(group_columns,
                               sep="_",
                               collapse="+"))
            })
  # print("table")
  print(z)
  cat('\n\n') 
}
```




```{r eval=FALSE}
cliff_chart <- function(){}

ggplot(data=clean_data, aes(x=eroi, y=dear, fill=income_bracket, color=income_bracket)) + 
  xlim(c(0,100)) + 
  ylim(c(0,1)) + 
  geom_point(aes(size=households), alpha=0.1, position="jitter") + 
  geom_hline(yintercept = .9) + 
  geom_vline(xintercept = 10) + 
  geom_smooth(method="lm",
              se=FALSE,
              fullrange=TRUE)
```





```{r eval=FALSE}
scatter_chart <- function(){}

ggplot(data=clean_data, aes(x=annual_income, y=mean_energy_cost, color=income_bracket)) + 
  xlim(c(0,200000)) +
  geom_point(aes(size=households), alpha=0.1) + 
  geom_smooth(method=lm,
                se=FALSE,
                fullrange=TRUE)
```

## Demographic Features Available

- company_na:                 Utility Company Name
- company_ty:                 Utility Company Type
- eia_id:                     EIA ID
- cust_cnt:                   Utility Customer Count
- avg_monthl:                 Average Monthly Consumption (kWh)
- avg_mon_01:                 Average Monthly Bill ($)
- dlrs_kwh:                   Average Cost of Electricity ($/kWh)
- avg_pbi_us:                 Average State Residential Solar Production-based Incentive ($/kWh)
- avg_cbi_us:                 Average State Residential Solar Capacity-based Incentive ($/W)
- avg_ibi_pc:                 Average State Residential Solar Investment-based Incentive (%)
- hh_size_1:                  Number of 1 person households
- hh_size_2:                  Number of 2 person households
- hh_size_3:                  Number of 3 person households
- hh_size_4:                  Number of 4 person households
- fam_med_in:                 Median family income
- hh_med_inc:                 Median household income
- hh_gini_in:                 Household GINI Index of Income Inequality
- pop_total:                  Total population
- pop_male:                   Total male population
- pop_female:                 Total female population
- pop_us_cit:                 Total US citizens
- pop_nat_us:                 Total naturalized US citizens
- pop_non_us:                 Total non-US citizens
- pop_hispan:                 Total hispanics
- pop_africa:                 Total african american population
- pop_asian:                  Total asian population
- pop_native:                 Total american indian/alaska native population
- pop_caucas:                 Total caucasian population
- pop25_some:                 Total population with at least some college education (Population 25 years and over)
- pop25_high:                 Total population with a high school diploma (Population 25 years and over)
- pop25_no_h:                 Total population with less than a high school diploma (Population 25 years and over)
- pop_med_ag:                 Median age
- p16_employ:                 Total employed (Population 16 years and over)
- p16_unempl:                 Total unemployed (Population 16 years and over)
- fam_childr:                 Total number of families with children under 6 years
- fam_chi_01:                 Total number of families with children ages 6-17 years
- pop_over_6:                 Total population over 65 years
- pop_under_:                 Total population under 18 years
- hu_monthly:                 Total number of owner-occupied units with housing costs less than $1000/month
- hu_mont_01:                 Total number of owner-occupied units with housing costs greater than $1000/month
- hu_own:                     Total number of owner occupied housing units
- hu_rent:                    Total number of renter occupied housing units
- hu_vintage:                 Number of occupied units built after 2010
- hu_vint_01:                 Number of occupied units built between 2000-2009
- hu_vint_02:                 Number of occupied units built between 1980-1999
- hu_vint_03:                 Number of occupied units built between 1960-1979
- hu_vint_04:                 Number of occupied units built between 1940-1959
- hu_vint_05:                 Number of occupied units built before 1939
- hu_med_val:                 Median value of owner-occupied housing units
- hu_mortgag:                 Number of owner-occupied housing units with a mortgage
- hu_no_mort:                 Number of owner-occupied housing units without a mortgage
- aqi_max:                    Max Air Quality Index
- aqi_max_de:                 Max Air Quality Index Description
- aqi_90th_p:                 90th Percentile Air Quality Index
- aqi_90t_01:                 90th Percentile Air Quality Index Description
- aqi_median:                 Median Air Quality Index
- aqi_med_01:                 Median Air Quality Index Description
- hdd:                        Heating Degree Days
- hdd_std:                    Heating Degree Days Standard Deviation
- hdd_ci:                     Heating Degree Days Confidence Interval
- cdd:                        Cooling Degree Days
- cdd_std:                    Cooling Degree Days Standard Deviation
- cdd_ci:                     Cooling Degree Days Confidence Interval
- climate_zo:                 Climate Zone
- climate_01:                 Climate Zone Description
- moisture_r:                 Moisture Regime
- locale:                     Locale
- total_unit:                 Total Number of Active Public Housing Units
- active_sub:                 Total Number of Active Subsidies
- avg_months:                 Average Months of Tenancy
- fmr_2br   :                 Fair Market Rent - 2 BR
- occ_rate  :                 Occupancy Rate
- pct_eli_hh:                 Percent Extremely Low Income
- lihtc_qual:                 Low Income Tax Credit Qualification 


```{r}
group_variable <- "company_ty"
group_columns <- c(group_variable)
graph_data <- filter_graph_data(clean_data, group_columns, metric_name)

gwm <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=1.0, 
                         lower_quantile_view=0.0)
print(gwm)
```

```{r}
group_variable <- "company_na"
group_columns <- c(group_variable)
graph_data <- filter_graph_data(clean_data, group_columns, metric_name)

gwm <- grouped_weighted_metrics(graph_data, 
                         group_columns, 
                         metric_name, 
                         metric_cutoff_level, 
                         upper_quantile_view=1.0, 
                         lower_quantile_view=0.0)
print(gwm)
```